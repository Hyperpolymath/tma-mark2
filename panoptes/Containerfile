# SPDX-FileCopyrightText: 2024 Panoptes Contributors
# SPDX-License-Identifier: MIT
#
# Panoptes Containerfile - RSR Gold Compliant
# Uses Chainguard Wolfi base image for minimal attack surface
#
# Build: podman build -t panoptes:latest .
# Run:   podman run -it --rm -v ~/Downloads:/data panoptes:latest scan /data

# =============================================================================
# Stage 1: Build
# =============================================================================
FROM cgr.dev/chainguard/wolfi-base:latest AS builder

# Install build dependencies
RUN apk add --no-cache \
    rust \
    cargo \
    gcc \
    musl-dev \
    openssl-dev \
    sqlite-dev \
    pkgconf

# Create build directory
WORKDIR /build

# Copy manifests first for better caching
COPY Cargo.toml Cargo.lock ./

# Create dummy source for dependency caching
RUN mkdir -p src/bin && \
    echo 'fn main() {}' > src/main.rs && \
    echo 'fn main() {}' > src/bin/panoptes-undo.rs && \
    echo 'fn main() {}' > src/bin/panoptes-web.rs && \
    echo '' > src/lib.rs

# Build dependencies only
RUN cargo build --release && \
    rm -rf src

# Copy actual source
COPY src/ src/

# Build the actual binary
RUN touch src/main.rs src/lib.rs && \
    cargo build --release --all-features

# =============================================================================
# Stage 2: Runtime
# =============================================================================
FROM cgr.dev/chainguard/wolfi-base:latest AS runtime

# Labels (OCI spec)
LABEL org.opencontainers.image.title="Panoptes"
LABEL org.opencontainers.image.description="AI-powered local file scanner"
LABEL org.opencontainers.image.version="3.0.0"
LABEL org.opencontainers.image.vendor="Panoptes Contributors"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.source="https://github.com/yourusername/panoptes"
LABEL org.opencontainers.image.documentation="https://github.com/yourusername/panoptes/wiki"

# Install runtime dependencies only
RUN apk add --no-cache \
    sqlite-libs \
    openssl \
    ca-certificates \
    tini

# Create non-root user (security best practice)
RUN addgroup -g 1000 panoptes && \
    adduser -u 1000 -G panoptes -h /home/panoptes -D panoptes

# Create data directories
RUN mkdir -p /data /home/panoptes/.local/share/panoptes && \
    chown -R panoptes:panoptes /data /home/panoptes

# Copy binaries from builder
COPY --from=builder /build/target/release/panoptes /usr/local/bin/
COPY --from=builder /build/target/release/panoptes-undo /usr/local/bin/
COPY --from=builder /build/target/release/panoptes-web /usr/local/bin/

# Ensure binaries are executable
RUN chmod +x /usr/local/bin/panoptes*

# Switch to non-root user
USER panoptes
WORKDIR /home/panoptes

# Environment
ENV PANOPTES_DATABASE="/home/panoptes/.local/share/panoptes/panoptes.db"
ENV PANOPTES_OLLAMA_URL="http://host.containers.internal:11434"
ENV RUST_LOG="info"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD panoptes system check || exit 1

# Volumes
VOLUME ["/data", "/home/panoptes/.local/share/panoptes"]

# Expose web dashboard port
EXPOSE 8080

# Use tini as init
ENTRYPOINT ["/sbin/tini", "--", "panoptes"]

# Default command
CMD ["--help"]

# =============================================================================
# Stage 3: Development (optional)
# =============================================================================
FROM builder AS development

# Install development tools
RUN apk add --no-cache \
    git \
    just \
    watchexec

# Create dev user
RUN addgroup -g 1000 dev && \
    adduser -u 1000 -G dev -h /home/dev -D dev

USER dev
WORKDIR /workspace

CMD ["cargo", "watch", "-x", "run"]
