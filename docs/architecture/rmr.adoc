// SPDX-FileCopyrightText: 2024 eTMA Handler Contributors
// SPDX-License-Identifier: MIT
= RMR Utility - Remove Reversible
:toc: left
:icons: font

== Overview

RMR (Remove Reversible) provides soft-delete functionality for eTMA Handler. Data removed via RMR can be recovered within the retention period.

== Concept

RMR mirrors the Unix `rm -r` command semantically but adds reversibility:

* Data is marked as deleted but not immediately purged
* Deleted items move to a recoverable state
* Automatic purge after configurable retention period
* Full audit trail maintained

== Usage

=== Soft Delete Operations

[source,elixir]
----
# Soft delete an assignment
EtmaHandler.Assignments.soft_delete(assignment_id)

# Soft delete with reason
EtmaHandler.Assignments.soft_delete(assignment_id, reason: "duplicate")
----

=== Recovery Operations

[source,elixir]
----
# List recoverable items
EtmaHandler.Recovery.list_deleted()

# Recover a specific item
EtmaHandler.Recovery.restore(assignment_id)

# Recover all items deleted in last hour
EtmaHandler.Recovery.restore_since(~U[2024-01-01 12:00:00Z])
----

== Retention Policy

[cols="2,1,2"]
|===
| Data Type | Default Retention | Configurable

| Assignments | 30 days | Yes
| Grades/Feedback | 30 days | Yes
| Backups | 7 days | Yes
| Audit Logs | 90 days | No (minimum)
|===

== Storage

Soft-deleted items stored in:

[source]
----
~/.local/share/etma_handler/
├── data/           # Active data
└── deleted/        # Soft-deleted (RMR) data
    ├── assignments/
    ├── grades/
    └── manifest.json  # Deletion metadata
----

== Audit Trail

Each RMR operation records:

* Timestamp
* Item type and ID
* User/session identifier
* Reason (if provided)
* Scheduled purge date

== Automatic Purge

A background process runs daily to:

1. Check items past retention period
2. Promote to RMO (obliterative delete)
3. Update audit log
4. Free storage space

== Configuration

In `config/config.exs`:

[source,elixir]
----
config :etma_handler, :rmr,
  retention_days: 30,
  auto_purge: true,
  purge_schedule: "0 3 * * *"  # 3 AM daily
----

== See Also

* link:rmo.adoc[RMO Utility] - Permanent deletion
* link:../REVERSIBILITY.md[Reversibility Policy]
