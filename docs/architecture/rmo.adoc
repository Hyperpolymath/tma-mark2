// SPDX-FileCopyrightText: 2024 eTMA Handler Contributors
// SPDX-License-Identifier: MIT
= RMO Utility - Remove Obliterative
:toc: left
:icons: font

== Overview

RMO (Remove Obliterative) provides permanent, unrecoverable deletion for eTMA Handler. Once data is removed via RMO, it cannot be recovered.

== Concept

RMO is the final stage of data deletion:

* Permanently removes data from storage
* Overwrites to prevent forensic recovery (optional)
* Required for GDPR "right to erasure" compliance
* Irreversible by design

== Usage

=== Permanent Delete Operations

[source,elixir]
----
# Permanently delete (requires confirmation)
EtmaHandler.Assignments.obliterate(assignment_id, confirm: true)

# Permanently delete with secure overwrite
EtmaHandler.Assignments.obliterate(assignment_id,
  confirm: true,
  secure: true
)
----

=== Bulk Operations

[source,elixir]
----
# Purge all items past retention (called by scheduler)
EtmaHandler.Recovery.purge_expired()

# Emergency purge specific items
EtmaHandler.Recovery.obliterate_batch(ids, confirm: true)
----

== Safety Measures

RMO operations require explicit safeguards:

=== Confirmation Required

[source,elixir]
----
# This will raise an error
EtmaHandler.Assignments.obliterate(id)
# => ** (ArgumentError) RMO requires explicit confirmation

# This works
EtmaHandler.Assignments.obliterate(id, confirm: true)
----

=== Audit Before Delete

Before any RMO operation:

1. Item metadata logged to audit trail
2. Checksum recorded for verification
3. Deletion timestamp recorded
4. Reason captured (if provided)

=== No Bulk Without Filter

[source,elixir]
----
# This will raise an error (too dangerous)
EtmaHandler.Recovery.obliterate_all(confirm: true)
# => ** (ArgumentError) Must specify filter criteria

# This works
EtmaHandler.Recovery.obliterate_batch(
  deleted_before: ~U[2024-01-01 00:00:00Z],
  confirm: true
)
----

== Secure Overwrite

When `secure: true` is specified:

1. Data overwritten with random bytes
2. Three-pass overwrite (DoD 5220.22-M pattern)
3. Storage compacted after operation

[source,elixir]
----
config :etma_handler, :rmo,
  secure_default: false,  # Set true for high-security environments
  overwrite_passes: 3
----

== GDPR Compliance

RMO supports "right to erasure" requests:

[source,elixir]
----
# Process erasure request
EtmaHandler.GDPR.process_erasure_request(
  student_id: "A1234567",
  confirm: true,
  audit_reference: "GDPR-2024-001"
)
----

This will:

1. Find all data associated with identifier
2. Log erasure request to permanent audit
3. Obliterate all matching data
4. Generate compliance certificate

== Audit Trail

RMO operations create permanent audit records:

[source,json]
----
{
  "operation": "rmo",
  "timestamp": "2024-12-01T10:30:00Z",
  "item_type": "assignment",
  "item_id": "abc123",
  "checksum": "sha256:...",
  "reason": "gdpr_erasure",
  "reference": "GDPR-2024-001",
  "secure_overwrite": true
}
----

Audit records are retained even after data deletion.

== Storage Recovery

After RMO operations, storage is reclaimed:

[source,elixir]
----
# Compact database after bulk deletions
EtmaHandler.Repo.compact()

# Check storage stats
EtmaHandler.Repo.stats()
# => %{size: 1_234_567, deleted_space: 0, ...}
----

== See Also

* link:rmr.adoc[RMR Utility] - Reversible deletion
* link:../REVERSIBILITY.md[Reversibility Policy]
